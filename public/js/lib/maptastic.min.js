/*! maptastic 2014-12-07 */
!function(){function a(b,c,d,e){if(d===c.length-1)return e(b);var f,g=c[d],h=Array(g);for(f=g-1;f>=0;--f)h[f]=a(b[f],c,d+1,e);return h}function b(a){for(var b=[];"object"==typeof a;)b.push(a.length),a=a[0];return b}function c(a){var c,d;return"object"==typeof a?(c=a[0],"object"==typeof c?(d=c[0],"object"==typeof d?b(a):[a.length,c.length]):[a.length]):[]}function d(a){var b,c=a.length,d=Array(c);for(b=c-1;-1!==b;--b)d[b]=a[b];return d}function e(b){return"object"!=typeof b?b:a(b,c(b),0,d)}function f(a,b){b=b||!1;var c,d,f,g,i,j,k,l,m,n=a.length,o=n-1,p=new Array(n);for(b||(a=e(a)),f=0;n>f;++f){for(k=f,j=a[f],m=h(j[f]),d=f+1;n>d;++d)g=h(a[d][f]),g>m&&(m=g,k=d);for(p[f]=k,k!=f&&(a[f]=a[k],a[k]=j,j=a[f]),i=j[f],c=f+1;n>c;++c)a[c][f]/=i;for(c=f+1;n>c;++c){for(l=a[c],d=f+1;o>d;++d)l[d]-=l[f]*j[d],++d,l[d]-=l[f]*j[d];d===o&&(l[d]-=l[f]*j[d])}}return{LU:a,P:p}}function g(a,b){var c,d,f,g,h,i=a.LU,j=i.length,k=e(b),l=a.P;for(c=j-1;-1!==c;--c)k[c]=b[c];for(c=0;j>c;++c)for(f=l[c],l[c]!==c&&(h=k[c],k[c]=k[f],k[f]=h),g=i[c],d=0;c>d;++d)k[c]-=k[d]*g[d];for(c=j-1;c>=0;--c){for(g=i[c],d=c+1;j>d;++d)k[c]-=k[d]*g[d];k[c]/=g[c]}return k}var h=Math.abs;solve=function(a,b,c){return g(f(a,c),b)}}();var Maptastic=function(a){var b=function(a,b,c){return a&&a.hasOwnProperty(b)?a[b]:c},c=b(a,"labels",!0),d=b(a,"crosshairs",!1),e=b(a,"autoSave",!0),f=b(a,"autoLoad",!0),g=b(a,"layers",[]),h=b(a,"onchange",function(){}),i="maptastic.layers",j=null,k=null,l=[],m=!1,n=!1,o=[],p=null,q=null,r=20,s=null,t=null,u=[],v=[],w=function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))},x=function(a,b,c,d){var e=b[1]*d[0]-b[0]*d[1]+(d[1]-b[1])*a[0]+(b[0]-d[0])*a[1],f=b[0]*c[1]-b[1]*c[0]+(b[1]-c[1])*a[0]+(c[0]-b[0])*a[1];if(0>e!=0>f)return!1;var g=-c[1]*d[0]+b[1]*(d[0]-c[0])+b[0]*(c[1]-d[1])+c[0]*d[1];return 0>g&&(e=-e,f=-f,g=-g),e>0&&f>0&&g>e+f},y=function(a,b){var c=x(a,b.targetPoints[0],b.targetPoints[1],b.targetPoints[2]),d=x(a,b.targetPoints[3],b.targetPoints[0],b.targetPoints[2]);return c||d},z=function(){h()},A=function(){if(m){k.strokeStyle="red",k.lineWidth=2,k.clearRect(0,0,j.width,j.height);for(var a=0;a<l.length;a++){k.beginPath(),k.strokeStyle=l[a]===t?"red":l[a]===p?"red":"white",k.moveTo(l[a].targetPoints[0][0],l[a].targetPoints[0][1]);for(var b=0;b<l[a].targetPoints.length;b++)k.lineTo(l[a].targetPoints[b][0],l[a].targetPoints[b][1]);k.lineTo(l[a].targetPoints[3][0],l[a].targetPoints[3][1]),k.closePath(),k.stroke();for(var e=[0,0],b=0;b<l[a].targetPoints.length;b++)k.strokeStyle=l[a].targetPoints[b]===s?"red":l[a].targetPoints[b]===q?"red":"white",e[0]+=l[a].targetPoints[b][0],e[1]+=l[a].targetPoints[b][1],k.beginPath(),k.arc(l[a].targetPoints[b][0],l[a].targetPoints[b][1],r/2,0,2*Math.PI,!1),k.stroke();if(e[0]/=4,e[1]/=4,c){var f=l[a].element.id.toUpperCase();k.font="16px sans-serif",k.textAlign="center";var g=k.measureText(f),h=[g.width+8,32];k.fillStyle="white",k.fillRect(e[0]-h[0]/2,e[1]-h[1]+8,h[0],h[1]),k.fillStyle="black",k.fillText(f,e[0],e[1])}}d&&(k.strokeStyle="yellow",k.lineWidth="1px",k.beginPath(),k.moveTo(u[0],0),k.lineTo(u[0],j.height),k.moveTo(0,u[1]),k.lineTo(j.width,u[1]),k.stroke())}},B=function(){j=document.createElement("canvas"),j.style.display="none",j.style.position="fixed",j.style.top="0px",j.style.left="0px",j.style.zIndex="1000000",k=j.getContext("2d"),document.body.appendChild(j),window.addEventListener("resize",M),window.addEventListener("mousemove",D),window.addEventListener("mouseup",E),window.addEventListener("mousedown",F),window.addEventListener("keydown",C),M()},C=function(a){if(!m)return 32==a.keyCode&&a.shiftKey?void K(!0):void 0;var b=a.keyCode,c=a.shiftKey?10:1,f=!1,g=[0,0];switch(b){case 32:if(a.shiftKey)return void K(!1);break;case 37:g[0]-=c;break;case 38:g[1]-=c;break;case 39:g[0]+=c;break;case 40:g[1]+=c;break;case 67:d=!d,f=!0;break;case 83:n=!1,f=!0}if(q)q[0]+=g[0],q[1]+=g[1],f=!0;else if(p){for(var h=0;h<p.targetPoints.length;h++)p.targetPoints[h][0]+=g[0],p.targetPoints[h][1]+=g[1];f=!0}f&&(J(),A(),e&&H(),z())},D=function(a){if(m)if(a.preventDefault(),v[0]=a.clientX-u[0],v[1]=a.clientY-u[1],u[0]=a.clientX,u[1]=a.clientY,n){var b=a.shiftKey?.1:1;if(q)q[0]+=v[0]*b,q[1]+=v[1]*b;else if(p)for(var c=0;c<p.targetPoints.length;c++)p.targetPoints[c][0]+=v[0]*b,p.targetPoints[c][1]+=v[1]*b;J(),e&&H(),A(),z()}else{j.style.cursor="default";var f=a.clientX,g=a.clientY,h=null!=s,i=null!=t;s=null;for(var c=0;c<l.length;c++)for(var k=l[c],o=0;o<k.targetPoints.length;o++){var x=k.targetPoints[o];if(w(x[0],x[1],f,g)<r){j.style.cursor="pointer",s=x;break}}t=null;for(var c=0;c<l.length;c++)if(y(u,l[c])){t=l[c];break}(d||h!=(null!=s)||i!=(null!=t))&&A()}},E=function(a){m&&(a.preventDefault(),n=!1)},F=function(a){if(m){a.preventDefault(),s=null,t?(p=t,n=!0):p=null,q=null;for(var b=a.clientX,c=a.clientY,d=0;d<l.length;d++)for(var e=l[d],f=0;f<e.targetPoints.length;f++){var g=e.targetPoints[f];if(w(g[0],g[1],b,c)<r){p=e,q=g,n=!0,o[0]=a.clientX-g[0],o[1]=a.clientY-g[1];break}}return A(),!1}},G=function(a,b){var c;if("string"==typeof a){if(c=document.getElementById(a),!c)throw"Maptastic: No element found with id: "+a}else a instanceof HTMLElement&&(c=a);for(var d=!1,e=0;e<l.length;e++)l[e].element.id==c.id&&(l[e].targetPoints=L(layout[i].targetPoints),d=!0);var f=c.offsetLeft,g=c.offsetTop;c.style.position="absolute",c.style.display="block",c.style.top="0px",c.style.left="0px",c.style.padding="0px",c.style.margin="0px";var h={element:c,width:c.clientWidth,height:c.clientHeight,sourcePoints:[],targetPoints:[]};if(h.sourcePoints.push([0,0],[h.width,0],[h.width,h.height],[0,h.height]),b)h.targetPoints=L(b);else{h.targetPoints.push([0,0],[h.width,0],[h.width,h.height],[0,h.height]);for(var i=0;i<h.targetPoints.length;i++)h.targetPoints[i][0]+=f,h.targetPoints[i][1]+=g}l.push(h),J()},H=function(){localStorage.setItem(i,JSON.stringify(N(l)))},I=function(){if(localStorage.getItem(i)){for(var a=JSON.parse(localStorage.getItem(i)),b=0;b<a.length;b++)for(var c=0;c<l.length;c++)l[c].element.id==a[b].id&&(l[c].targetPoints=L(a[b].targetPoints));J()}},J=function(){for(var a=(["","-webkit-","-moz-","-ms-","-o-"].reduce(function(a,b){return b+"transform"in document.body.style?b:a})+"transform"),b=0;b<l.length;b++){for(var c=[],d=[],e=0,f=l[b].sourcePoints.length;f>e;++e){var g=l[b].sourcePoints[e],h=l[b].targetPoints[e];c.push([g[0],g[1],1,0,0,0,-g[0]*h[0],-g[1]*h[0]]),d.push(h[0]),c.push([0,0,0,g[0],g[1],1,-g[0]*h[1],-g[1]*h[1]]),d.push(h[1])}var i=solve(c,d,!0),j=[i[0],i[3],0,i[6],i[1],i[4],0,i[7],0,0,1,0,i[2],i[5],0,1];l[b].element.style[a]="matrix3d("+j.join(",")+")",l[b].element.style[a+"-origin"]="0px 0px 0px"}},K=function(a){m=a,j.style.display=a?"block":"none",a?A():(q=null,p=null,n=!1)},L=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].slice(0,2));return b},M=function(){viewWidth=window.innerWidth,viewHeight=window.innerHeight,j.width=window.innerWidth,j.height=window.innerHeight,A()},N=function(){for(var a=[],b=0;b<l.length;b++)a.push({id:l[b].element.id,targetPoints:L(l[b].targetPoints)});return a},O=function(a){for(var b=0;b<a.length;b++){for(var c=!1,d=0;d<l.length;d++)l[d].element.id==a[b].id&&(console.log("Setting points."),l[d].targetPoints=L(a[b].targetPoints),c=!0);if(c)console.log("Maptastic: Element '"+a[b].id+"' is already mapped.");else{var e=document.getElementById(a[b].id);e?G(e,a[b].targetPoints):console.log("Maptastic: Can't find element: "+a[b].id)}}J(),A()};B();for(var P=0;P<g.length;P++)(g[P]instanceof HTMLElement||"string"==typeof g[P])&&G(g[P]);for(var P=0;P<arguments.length;P++)(arguments[P]instanceof HTMLElement||"string"==typeof arguments[P])&&G(arguments[P]);return f&&I(),{getLayout:function(){return N()},setLayout:function(a){O(a)},setConfigEnabled:function(a){K(a)},addLayer:function(a,b){G(a,b)}}};